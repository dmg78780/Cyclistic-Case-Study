#Most Popular Trips

SELECT start_station_name
,end_station_name
,COUNT(*) AS num_trips
FROM `bigquery-public-data.new_york_citibike.citibike_trips`
WHERE tripduration >= 0
GROUP BY start_station_name, end_station_name
ORDER BY num_trips DESC
LIMIT 10;

#Average Trip Length

SELECT start_station_name
,end_station_name
,AVG(tripduration) AS avg_trip_minutes
FROM `bigquery-public-data.new_york_citibike.citibike_trips`
WHERE tripduration >= 0
GROUP BY start_station_name, end_station_name
ORDER BY avg_trip_minutes DESC
LIMIT 10;

#Number of Yearly Trips, AVG of Length of Trip

SELECT EXTRACT (YEAR FROM starttime) AS trip_year
,ROUND(AVG(tripduration)) as avg_trip_minutes
,COUNT(*) as num_trips
FROM `bigquery-public-data.new_york_citibike.citibike_trips`
WHERE EXTRACT(YEAR FROM starttime) >= 0
GROUP BY trip_year
ORDER BY trip_year
LIMIT 10;

#Most traveled day of the week

SELECT FORMAT_DATE('%A', DATE(starttime)) AS day_of_week
,COUNT(*) AS trip_number
FROM `bigquery-public-data.new_york_citibike.citibike_trips`
WHERE EXTRACT(YEAR FROM starttime) >= 0
GROUP BY day_of_week
ORDER BY trip_number DESC;

#Trip Growth

WITH tripgrowth AS (
  SELECT EXTRACT(YEAR FROM starttime) AS trip_year
  ,COUNT(*) AS num_trips
  FROM bigquery-public-data.new_york_citibike.citibike_trips
  WHERE EXTRACT(YEAR FROM starttime) >=0
  GROUP BY trip_year
)
SELECT
trip_year
,num_trips
,LAG(num_trips) OVER (ORDER BY trip_year) AS prev_year_trips
,num_trips - LAG(num_trips) OVER (ORDER BY trip_year) AS trip_difference
,ROUND((num_trips - LAG(num_trips) OVER (ORDER BY trip_year))/ LAG(num_trips) OVER (ORDER BY trip_year) * 100, 1) AS percentage_growth
FROM tripgrowth
ORDER BY trip_year
LIMIT 10;

#Trends from 2015

SELECT EXTRACT (YEAR FROM starttime) AS trip_year
,EXTRACT (MONTH FROM starttime) AS trip_month_number
,FORMAT_DATE('%B', DATE(starttime)) as trip_month
,ROUND(AVG(tripduration)) AS avg_trip_minutes
,COUNT(*) AS num_trips
,gender
,COUNT(*) AS count_gender
,usertype
,COUNT(*) AS count_usertype
FROM `bigquery-public-data.new_york_citibike.citibike_trips`
WHERE EXTRACT(YEAR FROM starttime) = 2015
GROUP BY trip_year, trip_month, trip_month_number, gender, usertype
ORDER BY trip_month_number;

#Congestion at each Station

WITH daily_station_trips AS (
  SELECT DATE(starttime) AS trip_date
  ,start_station_id AS station_id
  ,COUNT(*) AS trips_out
  FROM `bigquery-public-data.new_york_citibike.citibike_trips`
  GROUP BY trip_date, start_station_id
  UNION ALL
  SELECT DATE(starttime) AS trip_date
  ,end_station_id AS station_id
  ,-COUNT(*) AS trips_in
  FROM `bigquery-public-data.new_york_citibike.citibike_trips`
  GROUP BY trip_date, end_station_id
)
SELECT trip_date
,station_id
,SUM(trips_out) AS net_trips
FROM daily_station_trips
GROUP BY trip_date, station_id
ORDER BY trip_date, station_id;


#Combine Zip Code Table, Weather Table, and CitiBikes Info Table. Provided by Coursera 
SELECT
TRI.usertype,
 ZIPSTART.zip_code AS zip_code_start,
 ZIPSTARTNAME.borough borough_start,
 ZIPSTARTNAME.neighborhood AS neighborhood_start,
  ZIPEND.zip_code AS zip_code_end,
  ZIPENDNAME.borough borough_end,
 ZIPENDNAME.neighborhood AS neighborhood_end,
  DATE_ADD(DATE(TRI.starttime), INTERVAL 5 YEAR) AS start_day,
  DATE_ADD(DATE(TRI.stoptime), INTERVAL 5 YEAR) AS stop_day,
  WEA.temp AS day_mean_temperature, -- Mean temp
 WEA.wdsp AS day_mean_wind_speed, -- Mean wind speed
  WEA.prcp day_total_precipitation, -- Total precipitation
 -- Group trips into 10 minute intervals to reduces the number of rows
  ROUND(CAST(TRI.tripduration / 60 AS INT64), -1) AS trip_minutes,
  COUNT(TRI.bikeid) AS trip_count
FROM
 `bigquery-public-data.new_york_citibike.citibike_trips` AS TRI
INNER JOIN
  `bigquery-public-data.geo_us_boundaries.zip_codes` ZIPSTART
 ON ST_WITHIN(
 ST_GEOGPOINT(TRI.start_station_longitude, TRI.start_station_latitude),
ZIPSTART.zip_code_geom)
INNER JOIN
  `bigquery-public-data.geo_us_boundaries.zip_codes` ZIPEND
  ON ST_WITHIN(
ST_GEOGPOINT(TRI.end_station_longitude, TRI.end_station_latitude),
ZIPEND.zip_code_geom)
INNER JOIN
`bigquery-public-data.noaa_gsod.gsod20*` AS WEA
  ON PARSE_DATE("%Y%m%d", CONCAT(WEA.year, WEA.mo, WEA.da)) = DATE(TRI.starttime)
INNER JOIN
  -- Note! Add your zip code table name, enclosed in backticks: `example_table`
  `eco-notch-431817-a3.Cyclistic.zip_codes` AS ZIPSTARTNAME
  ON ZIPSTART.zip_code = CAST(ZIPSTARTNAME.zip AS STRING)
INNER JOIN
  -- Note! Add your zipcode table name, enclosed in backticks: `example_table`
  `eco-notch-431817-a3.Cyclistic.zip_codes` AS ZIPENDNAME
  ON ZIPEND.zip_code = CAST(ZIPENDNAME.zip AS STRING)
WHERE
 -- This takes the weather data from one weather station
 WEA.wban = '94728' -- NEW YORK CENTRAL PARK
 -- Use data from 2014 and 2015
 AND EXTRACT(YEAR FROM DATE(TRI.starttime)) BETWEEN 2014 AND 2015
GROUP BY
 1, 
 2,
  3,
  4,
  5,
  6,
  7,
  8,
  9,
  10,
  11,
  12,
  13

#Capture data from just the summer season. Provided by Coursera.
SELECT
 TRI.usertype,
 TRI.start_station_longitude,
 TRI.start_station_latitude,
 TRI.end_station_longitude,
 TRI.end_station_latitude,
 ZIPSTART.zip_code AS zip_code_start,
 ZIPSTARTNAME.borough borough_start,
 ZIPSTARTNAME.neighborhood AS neighborhood_start,
 ZIPEND.zip_code AS zip_code_end,
  ZIPENDNAME.borough borough_end,
  ZIPENDNAME.neighborhood AS neighborhood_end,
 -- Since we're using trips from 2014 and 2015, we will add 5 years to make it look recent
  DATE_ADD(DATE(TRI.starttime), INTERVAL 5 YEAR) AS start_day,
 DATE_ADD(DATE(TRI.stoptime), INTERVAL 5 YEAR) AS stop_day,
  WEA.temp AS day_mean_temperature, -- Mean temp
 WEA.wdsp AS day_mean_wind_speed, -- Mean wind speed
  WEA.prcp day_total_precipitation, -- Total precipitation
  -- We will group trips into 10 minute intervals, which also reduces the number of rows
ROUND(CAST(TRI.tripduration / 60 AS INT64), -1) AS trip_minutes,
 TRI.bikeid
FROM  
 `bigquery-public-data.new_york_citibike.citibike_trips` AS TRI
INNER JOIN
`bigquery-public-data.geo_us_boundaries.zip_codes` ZIPSTART
ON ST_WITHIN(
ST_GEOGPOINT(TRI.start_station_longitude, TRI.start_station_latitude),
 ZIPSTART.zip_code_geom)
INNER JOIN
`bigquery-public-data.geo_us_boundaries.zip_codes` ZIPEND
ON ST_WITHIN(
 ST_GEOGPOINT(TRI.end_station_longitude, TRI.end_station_latitude),
ZIPEND.zip_code_geom)
INNER JOIN
 -- https://pantheon.corp.google.com/bigquery?p=bigquery-public-data&d=noaa_gsod
 `bigquery-public-data.noaa_gsod.gsod20*` AS WEA
 ON PARSE_DATE("%Y%m%d", CONCAT(WEA.year, WEA.mo, WEA.da)) = DATE(TRI.starttime)
INNER JOIN
-- Note! Add your zipcode table name, enclosed in backticks: `example_table`
`eco-notch-431817-a3.Cyclistic.zip_codes` AS ZIPSTARTNAME
ON ZIPSTART.zip_code = CAST(ZIPSTARTNAME.zip AS STRING)
INNER JOIN
 -- Note! Add your zipcode table name below, enclosed in backticks: `example_table`
  `eco-notch-431817-a3.Cyclistic.zip_codes` AS ZIPENDNAME
   ON ZIPEND.zip_code = CAST(ZIPENDNAME.zip AS STRING)
WHERE
-- Take the weather from one weather station
  WEA.wban = '94728' -- NEW YORK CENTRAL PARK
 -- Use data for three summer months
AND DATE(TRI.starttime) BETWEEN DATE('2015-07-01') AND DATE('2015-09-30')
